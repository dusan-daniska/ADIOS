# Getting started

```sh
composer create-project wai-blue/adios-app
cd adios-app
./bin/build.sh
```

With these simple commands you will create an ADIOS application based on the [simple CRM example](Prototype/examples/10-simple-crm). You will get a full-featured web-application with a default admin user.

<img src="Assets/images/login.png?raw=true">

Now, you are ready to customize.

# Customize

- [Getting started](#getting-started)
- [Customize](#customize)
  - [Folder structure](#folder-structure)
  - [Widgets](#widgets)
  - [Prototypes](#prototypes)
    - [Having troubles?](#having-troubles)
  - [Models](#models)
  - [Controllers (Actions)](#controllers-actions)
- [Conclusion](#conclusion)

## Folder structure

ADIOS application's root folder looks like this:

```
log/                 // app's log
upload/              // where your uploaded files are stored
src/                 // all source code of your application
  Widgets/           // app's widgets
    Customers/       // this is a widget
      Actions/       // implementation of controllers ("actions") of the widget
      Exceptions/    // custom exceptions of your widget
      Models/        // definition of models in the widget
      Templates/     // TWIG templates for the controllers
      Main.php       // "main" class of the widget
  Assets/            // all assets used in your app
    images/
    css/
   js/
  ConfigApp.php      // default configuration of your app
ConfigEnv.php        // environment-specific configuration of your app
```  

There are many in-built features like **routing** that respect this folder structure. This means that you do not have to routers if you do not need a very complex application. You just need to respect this folder structure.

## Widgets

Widget is a standalone piece of code inside your app. You can copy widgets from other apps or easily delete them and ADIOS will take care of the rest.

Every widget implements *models*, *views* and *controllers*:

  * models are implemented in the Models/ folder
  * views are implemented in the Templates/ folder
  * controllers are implemented in Actions/ folder

It's all about this - the models, views (templates) and controllers (actions).

## Prototypes

Generating of the ADIOS apps is done by the [Prototype Builder](Prototype/user-guide.md). The prototype builder uses simple JSON files to generate the PHP code. These JSON files contain the definition of the widgets, their models and UI.

The app generated by the prototype is the starting point for your further customization and development.

We recommend you to browse through the [examples](Prototype/examples) and try another prototype JSON files simply by changing the ```--input``` argument in the ```bin/build.sh``` (or ```bin/build.bat``` file).

### Having troubles?

Check out the [troubleshooting](Prototype/troubleshooting.md) section.

## Models

Simply create a file in ```src/Widgets/YOUR_WIDGET/Models``` and the model will be registered automatically.

Use class ```\ADIOS\Core\Model``` and a method ```columns()``` to define the structure of the model.

```php
class Customer extends \ADIOS\Core\Model {

  var $sqlName = "customers";  // name of the table in the SQL
  var $urlBase = "customers";  // URL at which the model's CRUD will be available

  public function columns($columns = []) {
    return parent::columns([
      "name" => [
        'type' => 'varchar',
        'title' => 'Customer name',
        'show_column' => true,
      ]
    );
  }
}
```

There are two magic properties:

  * ```$sqlName``` defines the name of the table in the SQL
  * ```$urlBase``` specifies the URL at which the model's CRUD will be available

Thanks to the ```$urlBase```, you do not need to configure routing, following URLs will become automatically available:

  * https://localhost/adios-app/customers - shows the table (listing) of the customers
  * https://localhost/adios-app/customers/Add - shows the inserting form
  * https://localhost/adios-app/customers/ID_CUSTOMER/edit - shows the editing form
  * and some others e.g. for importing from CSV or exporting to CSV

## Controllers (Actions)

Controllers in ADIOS are called 'actions'. Simply create a file in ```src/Widgets/YOUR_WIDGET/Actions``` and the action (controller) will be registered automatically.

You do not need to configure the routing, each action gets its URL automatically. The URL will contain the name of the widget and relative path to the action's file in the Actions/ folder. For example, the file ```src/Widgets/Customers/Actions/Dashboard/MonthlyTurnover.php``` will be routed from the URL http://localhost/adios-app/Customers/Dashboard/MonthlyTurnover.

Use method ```render()``` to directly render the HTML output.

```php
class Orders extends \ADIOS\Core\Widget\Action {
  public function render() {
    $orderModel = $this->adios->getModel("Widgets/Orders/Models/Order");
    $customerModel = $this->adios->getModel("Widgets/Customers/Models/Customer");

    $customer = $this->adios->db->select($customerModel)
      ->columns([\ADIOS\Core\DB\Query::allColumnsWithoutLookups])
      ->where([
        ['id', '=', (int) $this->params['id']]
      ])
      ->fetchOne()
    ;

    return $this->adios->view->Window([
      "uid" => "{$this->uid}_window",
      "title" => $customer['email'],
      "subtitle" => $this->translate("Orders"),
      "content" => 
        $this->adios->renderAction("UI/Table", [
          "model" => "Widgets/Orders/Models/Order",
          "where" => $orderModel->getFullTableSqlName().".id_customer = ".(int) $this->params['id'],
          "showTitle" => FALSE,
          "column_settings" => ["id_customer" => ["show_column" => FALSE]],
        ]),
    ])->render();
  }
}
```

Or use method ```preRender()``` to return the JSON output or to apply the TWIG template.

```php
class MonthlyTurnover extends \ADIOS\Core\Widget\Action {
  public function preRender() {
    $invoiceModel = new \ADIOS\Widgets\Finances\Models\Invoice($this->adios);
    $invoiceItemModel = new \ADIOS\Widgets\Finances\Models\InvoiceItem($this->adios);

    $turnover = $invoiceItemModel->pdoPrepareExecuteAndFetch("
      select
        year(`i`.`delivery_time`) as `year`,
        month(`i`.`delivery_time`) as `month`,
        sum(`ii`.`unit_price` * `ii`.`quantity`) as `turnover`
      from `:table` `ii`
      left join `".$invoiceModel->getFullTableSqlName()."` `i` on `i`.`id` = `ii`.`id_invoice`
      group by `i`.`delivery_time`
      having `year` = :year
      order by month(`i`.`delivery_time`)
    ", ["year" => (int) date("Y")]);

    foreach ($turnover as $turnoverMonth) {
      $data[$turnoverMonth['month']] = $turnoverMonth['turnover'];
    }

    return [
      "currentYear" => date("Y"),
      "data" => json_encode(array_values($data)),
    ];
  }
}
```

# Conclusion

Creating an ADIOS app is super fast and easy. By using a prototype builder and a JSON file, the app can be generated using the ```bin/build.sh``` script.
